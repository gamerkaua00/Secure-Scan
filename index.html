<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SecureScan | Multi-Layer Analysis</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JSZip para ler arquivos dentro de ZIP/APK/DOCX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b1121;
            color: #e2e8f0;
            overflow-x: hidden;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .glass-panel {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .drop-zone {
            background-image: repeating-linear-gradient(45deg, rgba(59, 130, 246, 0.05) 0, rgba(59, 130, 246, 0.05) 10px, transparent 10px, transparent 20px);
            border: 2px dashed #334155;
            transition: all 0.3s ease;
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
            transform: scale(1.005);
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: #3b82f6;
            box-shadow: 0 0 15px #3b82f6;
            animation: scanMove 2s linear infinite;
            z-index: 10;
        }

        @keyframes scanMove {
            0% { top: 0; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* Scrollbar customizada */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* Tabs Styles */
        .tab-btn {
            @apply px-4 py-2 text-sm font-medium rounded-lg transition-colors border border-transparent;
        }
        .tab-active {
            @apply bg-blue-600 text-white border-blue-500 shadow-lg shadow-blue-900/50;
        }
        .tab-inactive {
            @apply text-slate-400 hover:text-white hover:bg-slate-800;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="border-b border-slate-800 bg-slate-900/80 backdrop-blur sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-shield-halved text-blue-500 text-xl"></i>
                    <span class="font-bold text-lg tracking-tight text-white">SecureScan <span class="text-[10px] bg-blue-900/50 text-blue-300 px-2 py-0.5 rounded ml-1 border border-blue-500/30">SUITE</span></span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-[0_0_10px_#22c55e]"></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 flex flex-col items-center relative">
        
        <!-- Tab Switcher -->
        <div class="flex p-1 space-x-1 bg-slate-900/60 rounded-xl mb-8 border border-slate-800 backdrop-blur-sm z-10">
            <button onclick="switchTab('scanner')" id="btn-tab-scanner" class="tab-btn tab-active">
                <i class="fa-solid fa-file-magnifying-glass mr-2"></i>Escanear Arquivo
            </button>
            <button onclick="switchTab('device')" id="btn-tab-device" class="tab-btn tab-inactive">
                <i class="fa-solid fa-laptop-medical mr-2"></i>Auditoria do Sistema
            </button>
        </div>

        <!-- VIEW 1: FILE SCANNER -->
        <div id="view-scanner" class="w-full max-w-4xl flex flex-col items-center">
            <div class="text-center mb-8 max-w-3xl z-10">
                <h1 class="font-bold mb-4 text-3xl md:text-5xl text-white">
                    An√°lise de Arquivos
                </h1>
                <p class="text-slate-400 text-sm md:text-base max-w-xl mx-auto">
                    Detec√ß√£o de <span class="text-blue-400">assinaturas</span>, preven√ß√£o de <span class="text-blue-400">spoofing</span> e an√°lise profunda de <span class="font-mono text-xs bg-slate-800 px-1 rounded">.ZIP .APK .DOCX</span>.
                </p>
            </div>

            <!-- Scanner Card -->
            <div class="w-full glass-panel rounded-xl overflow-hidden relative min-h-[450px] flex flex-col">
                <!-- Upload State -->
                <div id="upload-area" class="flex-grow flex flex-col items-center justify-center p-8 transition-all duration-300">
                    <div class="drop-zone w-full max-w-lg h-64 rounded-xl flex flex-col items-center justify-center cursor-pointer relative group" onclick="document.getElementById('file-input').click()">
                        <input type="file" id="file-input" class="hidden" onchange="handleFileSelect(this)">
                        
                        <div class="w-20 h-20 bg-slate-800/50 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300 border border-slate-700 shadow-xl shadow-blue-900/10">
                            <i class="fa-solid fa-magnifying-glass-chart text-3xl text-blue-500"></i>
                        </div>
                        <p class="text-xl font-bold text-white mb-2">Carregar Arquivo</p>
                        <p class="text-xs text-slate-400 text-center max-w-[280px]">
                            Arraste ou clique. Suporta todos os formatos.<br>
                            <span class="text-slate-500">An√°lise estrutural e de conte√∫do ativa.</span>
                        </p>
                    </div>
                </div>

                <!-- Scanning State -->
                <div id="scanning-area" class="hidden absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center z-20">
                    <div class="scan-line"></div>
                    
                    <!-- Steps Visualization -->
                    <div class="flex items-center gap-2 mb-8">
                        <div id="step-1" class="w-3 h-3 rounded-full bg-slate-700 transition-colors"></div>
                        <div class="w-8 h-0.5 bg-slate-800"></div>
                        <div id="step-2" class="w-3 h-3 rounded-full bg-slate-700 transition-colors"></div>
                        <div class="w-8 h-0.5 bg-slate-800"></div>
                        <div id="step-3" class="w-3 h-3 rounded-full bg-slate-700 transition-colors"></div>
                    </div>

                    <div class="relative w-20 h-20 mb-6">
                        <div class="absolute inset-0 border-4 border-slate-700 rounded-full"></div>
                        <div class="absolute inset-0 border-4 border-blue-500 rounded-full border-t-transparent animate-spin"></div>
                        <i class="fa-solid fa-fingerprint absolute inset-0 flex items-center justify-center text-slate-500 text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-1" id="scan-status">Iniciando...</h3>
                    <p class="text-xs font-mono text-blue-400" id="scan-detail">Preparando ambiente seguro</p>
                </div>

                <!-- Result State -->
                <div id="result-area" class="hidden flex flex-col h-full animate-fade-in">
                    <!-- Header -->
                    <div class="bg-slate-800/50 p-6 border-b border-slate-700 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div class="flex items-center gap-4">
                            <div id="file-icon-wrapper" class="w-12 h-12 rounded-lg bg-slate-700 flex items-center justify-center text-2xl transition-colors">
                                <i class="fa-solid fa-file"></i>
                            </div>
                            <div class="overflow-hidden">
                                <h2 id="result-filename" class="font-bold text-white text-lg truncate max-w-[200px] md:max-w-sm">arquivo.zip</h2>
                                <div class="flex items-center gap-3 text-xs">
                                    <span id="result-size" class="text-slate-400">0 MB</span>
                                    <span id="file-hash" class="font-mono text-[10px] bg-slate-900 px-2 py-0.5 rounded text-slate-500 truncate max-w-[100px]" title="SHA-256 Hash">HASH...</span>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="resetScanner()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm transition-colors border border-slate-600 shadow-lg">
                            <i class="fa-solid fa-rotate-left mr-2"></i> Nova An√°lise
                        </button>
                    </div>

                    <!-- Painel de Resultados -->
                    <div class="flex-grow p-6 overflow-y-auto custom-scroll bg-slate-900/30">
                        
                        <!-- 1. Veredito Principal -->
                        <div id="verdict-panel" class="mb-6 p-4 rounded-xl border flex flex-col sm:flex-row items-start gap-4 transition-all">
                            <!-- JS Populate -->
                        </div>

                        <!-- 2. Grid de Detalhes -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            
                            <!-- Verifica√ß√£o de Spoofing -->
                            <div id="spoof-card" class="bg-slate-800/40 border border-slate-700 p-4 rounded-lg flex items-center gap-3">
                                <div id="spoof-icon" class="text-slate-500 text-xl"><i class="fa-solid fa-id-card"></i></div>
                                <div>
                                    <h4 class="text-xs font-bold text-slate-400 uppercase">Integridade Estrutural</h4>
                                    <p id="spoof-text" class="text-sm text-slate-300">Verificando magic bytes...</p>
                                </div>
                            </div>

                            <!-- Verifica√ß√£o de Hash -->
                            <div id="hash-card" class="bg-slate-800/40 border border-slate-700 p-4 rounded-lg flex items-center gap-3">
                                <div id="db-icon" class="text-slate-500 text-xl"><i class="fa-solid fa-database"></i></div>
                                <div>
                                    <h4 class="text-xs font-bold text-slate-400 uppercase">Banco de Dados Local</h4>
                                    <p id="db-text" class="text-sm text-slate-300">Hash n√£o consta na lista negra.</p>
                                </div>
                            </div>
                        </div>

                        <!-- 3. Deep Scan Report (Para ZIPs) -->
                        <div id="deep-scan-section" class="hidden">
                            <h4 class="text-slate-400 font-bold text-xs uppercase tracking-wider mb-3 flex justify-between items-center border-b border-slate-800 pb-2">
                                <span><i class="fa-solid fa-box-open mr-2"></i>Conte√∫do do Pacote</span>
                                <span id="files-count" class="text-slate-600 font-mono">0 arquivos</span>
                            </h4>
                            
                            <div class="bg-slate-900 border border-slate-800 rounded-lg overflow-hidden">
                                <div class="grid grid-cols-12 bg-slate-800/80 px-4 py-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider">
                                    <div class="col-span-8">Nome do Arquivo</div>
                                    <div class="col-span-4 text-right">An√°lise</div>
                                </div>
                                <div id="file-list-content" class="custom-scroll max-h-[250px] overflow-y-auto text-sm font-mono divide-y divide-slate-800/50">
                                    <!-- Lista de arquivos renderizada aqui -->
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: DEVICE AUDIT (NEW) -->
        <div id="view-device" class="hidden w-full max-w-4xl flex flex-col items-center">
            <div class="text-center mb-8 max-w-3xl z-10">
                <h1 class="font-bold mb-4 text-3xl md:text-5xl text-white">
                    Auditoria de Seguran√ßa
                </h1>
                <p class="text-slate-400 text-sm md:text-base max-w-xl mx-auto">
                    Verifique vulnerabilidades no seu navegador e conex√£o. <br>
                    <span class="text-yellow-500 text-xs"><i class="fa-solid fa-triangle-exclamation mr-1"></i> Nota: Sites n√£o podem escanear apps instalados no seu aparelho.</span>
                </p>
            </div>

            <div class="w-full glass-panel rounded-xl overflow-hidden p-6 md:p-8">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Browser Info -->
                    <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-lg bg-blue-500/20 text-blue-400 flex items-center justify-center text-xl">
                                <i class="fa-brands fa-chrome"></i>
                            </div>
                            <h3 class="font-bold text-lg text-white">Navegador</h3>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between border-b border-slate-700/50 pb-2">
                                <span class="text-slate-400 text-sm">User Agent</span>
                                <span id="audit-browser" class="text-white text-sm font-mono text-right w-1/2 truncate">Detectando...</span>
                            </div>
                            <div class="flex justify-between border-b border-slate-700/50 pb-2">
                                <span class="text-slate-400 text-sm">Plataforma (OS)</span>
                                <span id="audit-os" class="text-white text-sm font-bold">...</span>
                            </div>
                            <div class="flex justify-between items-center pt-1">
                                <span class="text-slate-400 text-sm">Cookies Habilitados</span>
                                <span id="audit-cookies" class="px-2 py-0.5 rounded text-xs font-bold bg-slate-700">...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Security Context -->
                    <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-lg bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-xl">
                                <i class="fa-solid fa-lock"></i>
                            </div>
                            <h3 class="font-bold text-lg text-white">Conex√£o & Rede</h3>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between border-b border-slate-700/50 pb-2">
                                <span class="text-slate-400 text-sm">Protocolo</span>
                                <span id="audit-protocol" class="text-white text-sm font-mono">HTTPS</span>
                            </div>
                            <div class="flex justify-between border-b border-slate-700/50 pb-2">
                                <span class="text-slate-400 text-sm">Contexto Seguro</span>
                                <span id="audit-secure" class="text-white text-sm">...</span>
                            </div>
                             <div class="flex justify-between items-center pt-1">
                                <span class="text-slate-400 text-sm">Do Not Track</span>
                                <span id="audit-dnt" class="px-2 py-0.5 rounded text-xs font-bold bg-slate-700">...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recommendation Panel -->
                <div class="mt-6 p-4 rounded-xl bg-slate-900/50 border border-slate-800">
                    <h4 class="text-sm font-bold text-slate-300 uppercase mb-3">Diagn√≥stico de Ambiente</h4>
                    <div id="audit-verdict" class="flex items-start gap-3">
                        <button onclick="runDeviceAudit()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold transition-colors">
                            Executar Auditoria
                        </button>
                        <p class="text-sm text-slate-400 mt-2">Clique para analisar a seguran√ßa b√°sica do seu ambiente de navega√ß√£o.</p>
                    </div>
                </div>

            </div>
        </div>

        <div class="mt-6 text-center text-xs text-slate-600 max-w-lg">
            <p><i class="fa-solid fa-lock mr-1"></i> Seguran√ßa: O c√≥digo roda 100% no seu navegador.</p>
            <p>Este sistema detecta padr√µes conhecidos, mas n√£o substitui um antiv√≠rus de sistema (Kernel-level).</p>
        </div>
    </main>

    <script>
        // --- TAB SWITCHING ---
        function switchTab(tabId) {
            const scannerView = document.getElementById('view-scanner');
            const deviceView = document.getElementById('view-device');
            const btnScanner = document.getElementById('btn-tab-scanner');
            const btnDevice = document.getElementById('btn-tab-device');

            if(tabId === 'scanner') {
                scannerView.classList.remove('hidden');
                deviceView.classList.add('hidden');
                
                btnScanner.className = 'tab-btn tab-active';
                btnDevice.className = 'tab-btn tab-inactive';
            } else {
                scannerView.classList.add('hidden');
                deviceView.classList.remove('hidden');
                
                btnScanner.className = 'tab-btn tab-inactive';
                btnDevice.className = 'tab-btn tab-active';
            }
        }

        // --- DEVICE AUDIT LOGIC ---
        function runDeviceAudit() {
            const ua = navigator.userAgent;
            const isSecure = window.isSecureContext;
            const cookies = navigator.cookieEnabled;
            const dnt = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
            const protocol = window.location.protocol;

            // Detect OS
            let os = "Desconhecido";
            if (ua.indexOf("Win") !== -1) os = "Windows";
            if (ua.indexOf("Mac") !== -1) os = "MacOS";
            if (ua.indexOf("Linux") !== -1) os = "Linux";
            if (ua.indexOf("Android") !== -1) os = "Android";
            if (ua.indexOf("like Mac") !== -1) os = "iOS";

            // Update UI
            document.getElementById('audit-browser').innerText = ua;
            document.getElementById('audit-os').innerText = os;
            document.getElementById('audit-protocol').innerText = protocol.toUpperCase().replace(':','');
            
            // Security Checks
            const secureEl = document.getElementById('audit-secure');
            if(isSecure) {
                secureEl.innerHTML = '<span class="text-green-400"><i class="fa-solid fa-check-circle"></i> Protegido</span>';
            } else {
                secureEl.innerHTML = '<span class="text-red-400"><i class="fa-solid fa-triangle-exclamation"></i> Inseguro</span>';
            }

            const cookieEl = document.getElementById('audit-cookies');
            cookieEl.innerText = cookies ? "Sim" : "N√£o";
            cookieEl.className = cookies ? "px-2 py-0.5 rounded text-xs font-bold bg-green-500/20 text-green-400" : "px-2 py-0.5 rounded text-xs font-bold bg-slate-700 text-slate-400";

            const dntEl = document.getElementById('audit-dnt');
            const dntActive = dnt === "1" || dnt === "yes";
            dntEl.innerText = dntActive ? "Ativado" : "Desativado";
            dntEl.className = dntActive ? "px-2 py-0.5 rounded text-xs font-bold bg-green-500/20 text-green-400" : "px-2 py-0.5 rounded text-xs font-bold bg-yellow-500/20 text-yellow-400";

            // Verdict
            const verdictEl = document.getElementById('audit-verdict');
            verdictEl.className = "flex flex-col gap-2";
            
            let advice = [];
            if (!isSecure) advice.push("‚ö†Ô∏è Voc√™ n√£o est√° usando HTTPS. Sua conex√£o pode ser interceptada.");
            if (!dntActive) advice.push("‚ÑπÔ∏è 'N√£o Rastrear' est√° desligado. Anunciantes podem te seguir.");
            if (os === "Android" || os === "iOS") advice.push("üì± Dispositivo M√≥vel detectado. Mantenha seu sistema operacional atualizado.");
            
            if (advice.length === 0) {
                 verdictEl.innerHTML = `
                    <div class="flex items-center gap-3 text-green-400 bg-green-500/10 p-3 rounded-lg w-full border border-green-500/20">
                        <i class="fa-solid fa-shield-check text-2xl"></i>
                        <div>
                            <h4 class="font-bold">Ambiente Seguro</h4>
                            <p class="text-xs text-green-300">Navegador atualizado e conex√£o segura detectada.</p>
                        </div>
                    </div>
                `;
            } else {
                verdictEl.innerHTML = `
                    <div class="w-full space-y-2">
                        ${advice.map(item => `<div class="text-sm text-slate-300 bg-slate-800 p-2 rounded border border-slate-700">${item}</div>`).join('')}
                    </div>
                `;
            }
        }

        // --- 1. BANCO DE DADOS DE AMEA√áAS (SIGNATURES) ---
        const THREAT_DB = {
            '275a021bbfb6489e54d471899f7db9d1663fc695ec2fe2a2c4538aabf651fd0f': 'EICAR Test File (Arquivo de Teste Seguro)',
            '44d88612fea8a8f36de82e1278abb02f': 'EICAR Test (MD5)',
            '24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c': 'WannaCry Ransomware (Dropper)',
            'cfc757367c29379899f8d52362a938db': 'WannaCry (Variante)',
            '5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8': 'WannaCry (Componente)',
            'a294620543334a721a2e54764663e17b43b323c9655f633d9a1ee72054c52f0e': 'Stuxnet Worm'
        };

        // --- 2. CONFIGURA√á√ïES HEUR√çSTICAS ---
        const DANGEROUS_EXTENSIONS = ['exe', 'bat', 'cmd', 'sh', 'vbs', 'scr', 'js', 'jar', 'com', 'msi', 'apk', 'pif', 'application', 'gadget'];
        
        const MALICIOUS_PATTERNS = [
            { id: 'js_eval', regex: /eval\s*\(/i, desc: 'Obfusca√ß√£o JS (eval)' },
            { id: 'shell_ps', regex: /powershell(\.exe)?/i, desc: 'Comando PowerShell' },
            { id: 'shell_cmd', regex: /cmd(\.exe)?\s*\/c/i, desc: 'Execu√ß√£o de Terminal Windows' },
            { id: 'vba_macro', regex: /Attribute\s+VB_Name/i, desc: 'Macro VBA (Office)' },
            { id: 'base64_pe', regex: /TVqQAAMAAAAEAAAA/i, desc: 'Execut√°vel Base64 Embutido' }, // Header MZ em Base64
            { id: 'pdf_js', regex: /\/JavaScript|\/JS/i, desc: 'Script em PDF' },
            { id: 'autorun', regex: /\[autorun\]/i, desc: 'Arquivo Autorun.inf' }
        ];

        // Magic Bytes para detectar Spoofing (Extens√£o falsa)
        const MAGIC_NUMBERS = {
            'ffd8ff': 'jpg', '89504e47': 'png', '25504446': 'pdf',
            '504b0304': 'zip', '52617221': 'rar', '4d5a': 'exe', '7f454c46': 'elf'
        };

        // --- ESTADO DA UI ---
        const ui = {
            upload: document.getElementById('upload-area'),
            scanning: document.getElementById('scanning-area'),
            result: document.getElementById('result-area'),
            status: document.getElementById('scan-status'),
            detail: document.getElementById('scan-detail'),
            filename: document.getElementById('result-filename'),
            filesize: document.getElementById('result-size'),
            fileHash: document.getElementById('file-hash'),
            verdict: document.getElementById('verdict-panel'),
            fileIcon: document.getElementById('file-icon-wrapper'),
            spoofCard: { text: document.getElementById('spoof-text'), icon: document.getElementById('spoof-icon') },
            dbCard: { text: document.getElementById('db-text'), icon: document.getElementById('db-icon') },
            deepScan: {
                section: document.getElementById('deep-scan-section'),
                list: document.getElementById('file-list-content'),
                count: document.getElementById('files-count')
            },
            steps: [document.getElementById('step-1'), document.getElementById('step-2'), document.getElementById('step-3')]
        };

        // --- EVENTOS ---
        function handleFileSelect(input) {
            if(input.files.length) processFile(input.files[0]);
        }
        
        const dropZone = document.querySelector('.drop-zone');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
            dropZone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); });
        });
        ['dragenter', 'dragover'].forEach(() => dropZone.classList.add('dragover'));
        ['dragleave', 'drop'].forEach(() => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            if(e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]);
        });

        // --- L√ìGICA PRINCIPAL (PIPELINE) ---
        async function processFile(file) {
            resetUI();
            ui.upload.classList.add('hidden');
            ui.scanning.classList.remove('hidden');

            ui.filename.innerText = file.name;
            ui.filesize.innerText = formatBytes(file.size);

            let globalRisk = 'clean'; // clean, warning, danger
            let globalReason = 'Arquivo parece limpo.';

            // --- PASSO 1: C√ÅLCULO DE HASH E ASSINATURAS ---
            setStep(0);
            updateStatus("Verificando Assinatura...", "Calculando Hash SHA-256");
            const hash = await calculateSHA256(file);
            ui.fileHash.innerText = hash.substring(0, 16) + '...';
            ui.fileHash.title = hash;

            // Check DB
            if (THREAT_DB[hash]) {
                globalRisk = 'danger';
                globalReason = `Malware Conhecido Detectado: ${THREAT_DB[hash]}`;
                updateDbCard('danger', globalReason);
            } else {
                updateDbCard('clean', 'Nenhuma correspond√™ncia no banco de dados local.');
            }

            await sleep(400);

            // --- PASSO 2: ESTRUTURA E SPOOFING ---
            setStep(1);
            updateStatus("An√°lise Estrutural...", "Verificando Magic Bytes");
            const magicHeader = await readFileHeader(file);
            const ext = file.name.split('.').pop().toLowerCase();
            
            const spoofCheck = checkSpoofing(magicHeader, ext);
            if (spoofCheck.isSpoofed) {
                // Se j√° era danger, mant√©m. Se n√£o, vira danger.
                if (globalRisk !== 'danger') {
                    globalRisk = 'danger';
                    globalReason = `Extens√£o falsa detectada! O arquivo finge ser .${ext} mas √© .${spoofCheck.realType}.`;
                }
                updateSpoofCard('danger', `Alerta: Header bin√°rio indica arquivo .${spoofCheck.realType.toUpperCase()}`);
            } else {
                updateSpoofCard('clean', `Assinatura bin√°ria compat√≠vel com .${ext.toUpperCase()}`);
            }

            await sleep(400);

            // --- PASSO 3: DEEP SCAN (ZIP/CONTAINER) ---
            setStep(2);
            const isContainer = ['zip', 'docx', 'xlsx', 'pptx', 'jar', 'apk'].includes(ext);
            let deepResults = [];

            if (isContainer && globalRisk !== 'danger') {
                updateStatus("Extraindo Container...", "Buscando execut√°veis ocultos");
                try {
                    deepResults = await scanZipContainer(file);
                    
                    // Analisar resultados do deep scan
                    const threats = deepResults.filter(r => r.status === 'danger');
                    if (threats.length > 0) {
                        globalRisk = 'danger';
                        globalReason = `Encontrado(s) ${threats.length} arquivo(s) malicioso(s) dentro do pacote.`;
                    }
                } catch (e) {
                    console.log(e);
                    deepResults = [{ name: 'Erro de Extra√ß√£o', status: 'warning', reason: 'Arquivo corrompido ou protegido por senha.' }];
                    if (globalRisk === 'clean') {
                        globalRisk = 'warning';
                        globalReason = 'N√£o foi poss√≠vel verificar o conte√∫do interno.';
                    }
                }
            } else if (!isContainer && isAnalysable(ext) && globalRisk !== 'danger') {
                // Scan arquivo texto √∫nico
                updateStatus("An√°lise Heur√≠stica...", "Lendo c√≥digo fonte");
                const res = await scanSingleFile(file, file.name);
                if (res.status === 'danger') {
                    globalRisk = 'danger';
                    globalReason = res.reason;
                }
            }

            await sleep(500);
            renderFinalResult(globalRisk, globalReason, deepResults, isContainer);
        }

        // --- FUN√á√ïES DE AN√ÅLISE ---

        async function calculateSHA256(file) {
            const buffer = await file.arrayBuffer();
            const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function readFileHeader(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = function(e) {
                    const arr = (new Uint8Array(e.target.result)).subarray(0, 4);
                    let header = "";
                    for(let i = 0; i < arr.length; i++) header += arr[i].toString(16).padStart(2, '0');
                    resolve(header);
                };
                reader.readAsArrayBuffer(file.slice(0, 4));
            });
        }

        function checkSpoofing(header, ext) {
            // Verifica se √© um execut√°vel disfar√ßado de documento seguro
            const isExe = header.startsWith('4d5a'); // MZ
            const safeExtensions = ['pdf', 'jpg', 'png', 'txt', 'docx', 'xlsx', 'pptx'];
            
            if (isExe && safeExtensions.includes(ext)) {
                return { isSpoofed: true, realType: 'exe' };
            }
            return { isSpoofed: false };
        }

        async function scanZipContainer(file) {
            const zip = new JSZip();
            const contents = await zip.loadAsync(file);
            const results = [];
            const fileNames = Object.keys(contents.files);

            for (const filename of fileNames) {
                const zipObj = contents.files[filename];
                if (zipObj.dir) continue;

                const internalExt = filename.split('.').pop().toLowerCase();
                let analysis = { name: filename, status: 'clean', reason: '' };

                // 1. Regra de Extens√£o Proibida
                if (DANGEROUS_EXTENSIONS.includes(internalExt)) {
                    analysis = { name: filename, status: 'danger', reason: `Execut√°vel (.${internalExt}) oculto no zip` };
                } 
                // 2. An√°lise de Conte√∫do
                else if (isAnalysable(internalExt)) {
                    try {
                        const text = await zipObj.async("string");
                        const patterns = scanTextForPatterns(text, internalExt);
                        if (patterns.length > 0) {
                            analysis = { name: filename, status: 'danger', reason: patterns.join(', ') };
                        }
                    } catch(e) {}
                }

                if (analysis.status !== 'clean') results.push(analysis);
                else results.push({name: filename, status: 'clean', reason: 'OK'}); // Limita output visual depois
            }
            return results;
        }

        async function scanSingleFile(file, filename) {
            const ext = filename.split('.').pop().toLowerCase();
            try {
                const text = await file.text();
                const patterns = scanTextForPatterns(text, ext);
                if (patterns.length > 0) return { name: filename, status: 'danger', reason: patterns.join(', ') };
            } catch (e) {}
            return { name: filename, status: 'clean', reason: 'Limpo' };
        }

        function scanTextForPatterns(text, ext) {
            const found = [];
            const snippet = text.slice(0, 150000); // Scan first 150KB
            MALICIOUS_PATTERNS.forEach(pat => {
                if (pat.id.includes('pdf') && ext !== 'pdf') return;
                if (pat.regex.test(snippet)) found.push(pat.desc);
            });
            return found;
        }

        function isAnalysable(ext) {
            return ['js', 'html', 'htm', 'xml', 'txt', 'php', 'py', 'json', 'pdf', 'svg', 'rtf', 'ps1'].includes(ext);
        }

        // --- MANIPULA√á√ÉO DE UI ---

        function renderFinalResult(risk, reason, deepFiles, isContainer) {
            ui.scanning.classList.add('hidden');
            ui.result.classList.remove('hidden');

            const verdictPanel = ui.verdict;
            let iconClass = '';
            let colorClass = '';
            let title = '';

            if (risk === 'danger') {
                colorClass = 'red';
                title = 'Amea√ßa Detectada';
                iconClass = 'fa-biohazard animate-pulse';
            } else if (risk === 'warning') {
                colorClass = 'yellow';
                title = 'Aten√ß√£o Requerida';
                iconClass = 'fa-triangle-exclamation';
            } else {
                colorClass = 'green';
                title = 'Arquivo Seguro';
                iconClass = 'fa-shield-check';
            }

            // Configurar Veredito
            verdictPanel.className = `mb-6 p-5 rounded-xl border flex flex-col sm:flex-row items-start gap-4 bg-${colorClass}-500/10 border-${colorClass}-500/30`;
            verdictPanel.innerHTML = `
                <div class="w-12 h-12 rounded-lg bg-${colorClass}-500/20 text-${colorClass}-500 flex items-center justify-center text-3xl shrink-0">
                    <i class="fa-solid ${iconClass}"></i>
                </div>
                <div>
                    <h3 class="text-${colorClass}-400 font-bold text-xl">${title}</h3>
                    <p class="text-${colorClass}-100/80 text-sm mt-1 leading-relaxed">${reason}</p>
                </div>
            `;

            ui.fileIcon.className = `w-12 h-12 rounded-lg bg-${colorClass}-500/20 text-${colorClass}-500 flex items-center justify-center text-2xl transition-colors`;

            // Configurar Deep Scan UI
            if (isContainer) {
                ui.deepScan.section.classList.remove('hidden');
                ui.deepScan.count.innerText = `${deepFiles.length} arquivos`;
                
                // Priorizar amea√ßas no topo
                deepFiles.sort((a, b) => (a.status === 'danger' ? -1 : 1));

                ui.deepScan.list.innerHTML = deepFiles.map(f => {
                    let color = f.status === 'danger' ? 'red-500' : (f.status === 'warning' ? 'yellow-500' : 'slate-500');
                    let icon = f.status === 'danger' ? 'fa-bug' : 'fa-check';
                    let statusText = f.status === 'danger' ? 'V√çRUS' : 'OK';
                    
                    return `
                    <div class="grid grid-cols-12 px-4 py-2 hover:bg-slate-800 transition-colors border-b border-slate-800/50 last:border-0">
                        <div class="col-span-8 flex items-center gap-2 overflow-hidden">
                            <i class="fa-regular fa-file text-slate-600 text-xs"></i>
                            <div class="truncate text-slate-300" title="${f.name}">
                                ${f.name}
                                ${f.reason ? `<div class="text-[10px] text-${color}">${f.reason}</div>` : ''}
                            </div>
                        </div>
                        <div class="col-span-4 text-right text-xs pt-1 font-bold text-${color}">
                            <i class="fa-solid ${icon} mr-1"></i> ${statusText}
                        </div>
                    </div>`;
                }).join('');
            } else {
                ui.deepScan.section.classList.add('hidden');
            }
        }

        function updateSpoofCard(status, text) {
            const color = status === 'danger' ? 'red' : 'green';
            const icon = status === 'danger' ? 'fa-circle-xmark' : 'fa-circle-check';
            ui.spoofCard.icon.className = `text-${color}-500 text-xl`;
            ui.spoofCard.icon.innerHTML = `<i class="fa-solid ${icon}"></i>`;
            ui.spoofCard.text.innerText = text;
            ui.spoofCard.text.className = `text-sm text-${color}-200/80`;
        }

        function updateDbCard(status, text) {
            const color = status === 'danger' ? 'red' : 'green';
            const icon = status === 'danger' ? 'fa-database text-red-500 animate-pulse' : 'fa-database';
            ui.dbCard.icon.className = `text-${color}-500 text-xl`;
            ui.dbCard.icon.innerHTML = `<i class="fa-solid ${icon}"></i>`;
            ui.dbCard.text.innerText = text;
            ui.dbCard.text.className = `text-sm text-${color}-200/80`;
        }

        // --- UTILIT√ÅRIOS ---
        function updateStatus(text, subtext) {
            ui.status.innerText = text;
            ui.detail.innerText = subtext;
        }

        function setStep(index) {
            ui.steps.forEach((el, i) => {
                if (i <= index) el.classList.replace('bg-slate-700', 'bg-blue-500');
                else el.classList.replace('bg-blue-500', 'bg-slate-700');
            });
        }

        function formatBytes(bytes) {
            if (!+bytes) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
        }

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

        function resetUI() {
            ui.result.classList.add('hidden');
            ui.steps.forEach(el => el.classList.replace('bg-blue-500', 'bg-slate-700'));
        }

        function resetScanner() {
            ui.result.classList.add('hidden');
            ui.upload.classList.remove('hidden');
            document.getElementById('file-input').value = '';
        }
    </script>
</body>
</html>