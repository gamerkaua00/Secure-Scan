<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SecureScan Enterprise | Advanced Threat Analysis</title>
    
    <!-- Meta Tags -->
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="Client-Side Heuristic Engine">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JSZip for Archives -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: { 850: '#151f32', 900: '#0f172a', 950: '#020617' },
                        cyber: { 500: '#00f0ff', 900: '#004c52' }
                    },
                    animation: {
                        'scan-vertical': 'scan 2s linear infinite',
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        scan: {
                            '0%': { top: '0%', opacity: '0' },
                            '10%': { opacity: '1' },
                            '90%': { opacity: '1' },
                            '100%': { top: '100%', opacity: '0' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar for Terminal feel */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .terminal-text {
            text-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
        }

        .crt::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        .scan-grid {
            background-image: linear-gradient(rgba(59, 130, 246, 0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(59, 130, 246, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 min-h-screen flex flex-col font-sans overflow-x-hidden selection:bg-blue-500/30">

    <!-- Header -->
    <nav class="border-b border-slate-800 bg-slate-900/80 backdrop-blur sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <i class="fa-solid fa-shield-virus text-blue-500 text-2xl"></i>
                    <div class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                </div>
                <div>
                    <h1 class="font-bold text-lg tracking-tight text-white leading-none">SECURE<span class="text-blue-500">SCAN</span></h1>
                    <span class="text-[10px] font-mono text-slate-400 uppercase tracking-widest">Enterprise Edition</span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="hidden md:flex items-center gap-2 text-xs font-mono text-slate-400">
                    <span class="w-2 h-2 bg-green-500 rounded-full shadow-[0_0_8px_rgba(34,197,94,0.6)]"></span>
                    <span>SYSTEM ONLINE</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto px-4 py-8 flex flex-col gap-6 relative z-10">
        
        <!-- Tab Control -->
        <div class="flex justify-center mb-4">
            <div class="bg-slate-900 p-1 rounded-lg border border-slate-800 inline-flex">
                <button onclick="switchTab('scanner')" id="tab-scanner" class="px-6 py-2 rounded-md text-sm font-medium transition-all bg-blue-600 text-white shadow-lg shadow-blue-900/20">
                    <i class="fa-solid fa-microchip mr-2"></i>Heurística
                </button>
                <button onclick="switchTab('audit')" id="tab-audit" class="px-6 py-2 rounded-md text-sm font-medium transition-all text-slate-400 hover:text-white hover:bg-slate-800">
                    <i class="fa-solid fa-user-secret mr-2"></i>Ambiente
                </button>
            </div>
        </div>

        <!-- VIEW: SCANNER -->
        <div id="view-scanner" class="max-w-5xl mx-auto w-full grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in">
            
            <!-- Left: Drop Zone & Visuals -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Drop Zone -->
                <div class="glass-panel rounded-xl p-1 relative overflow-hidden group">
                    <div class="absolute inset-0 scan-grid opacity-30"></div>
                    <div id="drop-zone" class="bg-slate-900/50 border-2 border-dashed border-slate-700 rounded-lg h-64 flex flex-col items-center justify-center cursor-pointer transition-all hover:border-blue-500 hover:bg-blue-500/5 relative overflow-hidden" onclick="document.getElementById('file-input').click()">
                        
                        <!-- Static State -->
                        <div id="ui-upload-static" class="text-center z-10 pointer-events-none transition-opacity duration-300">
                            <div class="w-16 h-16 bg-slate-800 rounded-xl flex items-center justify-center mx-auto mb-4 border border-slate-700 shadow-xl group-hover:scale-110 transition-transform">
                                <i class="fa-solid fa-magnifying-glass-chart text-3xl text-blue-500"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-1">Arraste ou Clique</h3>
                            <p class="text-xs text-slate-400 font-mono">Suporte: EXE, PDF, DOCX, ZIP, APK...</p>
                        </div>

                        <!-- Scanning State (Hidden) -->
                        <div id="ui-scanning-anim" class="absolute inset-0 bg-slate-950 flex flex-col items-center justify-center hidden z-20">
                            <div class="w-full absolute top-0 h-1 bg-blue-500 shadow-[0_0_20px_#3b82f6] animate-scan-vertical"></div>
                            <div class="font-mono text-blue-400 text-4xl mb-2 font-bold tracking-tighter" id="scan-percent">0%</div>
                            <div class="font-mono text-xs text-slate-500 uppercase tracking-widest animate-pulse">Analisando Buffers</div>
                        </div>

                        <input type="file" id="file-input" class="hidden" onchange="handleFile(this.files[0])">
                    </div>
                </div>

                <!-- Results Section (Initially Hidden) -->
                <div id="result-panel" class="hidden space-y-4">
                    <!-- Verdict Header -->
                    <div id="verdict-banner" class="glass-panel p-5 rounded-xl border-l-4 flex items-center justify-between transition-all">
                        <div class="flex items-center gap-4">
                            <div id="verdict-icon" class="w-12 h-12 rounded-lg flex items-center justify-center text-2xl bg-slate-800"></div>
                            <div>
                                <h2 id="verdict-title" class="font-bold text-xl text-white"></h2>
                                <p id="verdict-desc" class="text-sm font-mono text-slate-300"></p>
                            </div>
                        </div>
                        <div class="text-right hidden sm:block">
                            <div class="text-[10px] text-slate-500 uppercase tracking-widest">Score de Risco</div>
                            <div id="risk-score" class="text-2xl font-bold font-mono">0/10</div>
                        </div>
                    </div>

                    <!-- Details Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Entropy Card -->
                        <div class="bg-slate-900/80 border border-slate-800 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-bold text-slate-400 uppercase"><i class="fa-solid fa-chart-simple mr-2"></i>Entropia</span>
                                <span id="val-entropy" class="text-xs font-mono bg-slate-800 px-2 py-0.5 rounded">0.00</span>
                            </div>
                            <div class="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden">
                                <div id="bar-entropy" class="bg-blue-500 h-full w-0 transition-all duration-1000"></div>
                            </div>
                            <p class="text-[10px] text-slate-500 mt-2">Valores > 7.5 indicam compressão ou criptografia (comum em malware empacotado).</p>
                        </div>

                        <!-- File Info -->
                        <div class="bg-slate-900/80 border border-slate-800 p-4 rounded-lg font-mono text-xs space-y-2">
                            <div class="flex justify-between border-b border-slate-800 pb-1">
                                <span class="text-slate-500">Tipo (Magic):</span>
                                <span id="val-magic" class="text-blue-300">...</span>
                            </div>
                            <div class="flex justify-between border-b border-slate-800 pb-1">
                                <span class="text-slate-500">Tamanho:</span>
                                <span id="val-size" class="text-white">...</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-500">SHA-256:</span>
                                <button onclick="copyHash()" class="text-[10px] bg-slate-800 hover:bg-slate-700 px-2 py-1 rounded transition-colors"><i class="fa-regular fa-copy"></i> Copiar</button>
                            </div>
                            <div id="val-hash" class="text-[10px] text-slate-600 break-all truncate">...</div>
                        </div>
                    </div>

                    <!-- Deep Scan List (for ZIP/Containers) -->
                    <div id="container-analysis" class="hidden bg-slate-900/80 border border-slate-800 rounded-lg overflow-hidden">
                        <div class="px-4 py-2 bg-slate-800/50 border-b border-slate-800 text-xs font-bold text-slate-400 uppercase flex justify-between">
                            <span>Conteúdo do Pacote</span>
                            <span id="files-count" class="bg-slate-700 px-1.5 rounded text-white">0</span>
                        </div>
                        <div id="container-list" class="max-h-40 overflow-y-auto p-2 space-y-1 custom-scroll">
                            <!-- JS Generated -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Terminal / Log Output -->
            <div class="lg:col-span-1 h-full">
                <div class="glass-panel rounded-xl h-full min-h-[400px] flex flex-col border border-slate-700/50 bg-[#0c0f16]">
                    <div class="h-8 bg-slate-800/50 border-b border-slate-700 flex items-center px-3 justify-between">
                        <span class="text-[10px] font-mono font-bold text-slate-400"><i class="fa-solid fa-terminal mr-2"></i>SYSTEM LOG</span>
                        <div class="flex gap-1.5">
                            <div class="w-2.5 h-2.5 rounded-full bg-slate-700"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-slate-700"></div>
                        </div>
                    </div>
                    <div id="terminal-output" class="flex-grow p-4 font-mono text-[11px] overflow-y-auto text-slate-300 space-y-1 custom-scroll">
                        <div class="text-blue-500">Welcome to SecureScan v4.0.1 Enterprise</div>
                        <div class="text-slate-500">Initializing heuristic engine...</div>
                        <div class="text-slate-500">Ready for input.</div>
                        <div class="animate-pulse text-blue-500">_</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: AUDIT -->
        <div id="view-audit" class="hidden max-w-2xl mx-auto w-full animate-fade-in">
            <div class="glass-panel p-8 rounded-xl border border-slate-700">
                <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                    <i class="fa-solid fa-fingerprint text-blue-500"></i> Auditoria de Ambiente
                </h2>
                
                <div class="space-y-4" id="audit-list">
                    <!-- JS Populates -->
                </div>

                <button onclick="runAudit()" class="mt-6 w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 text-white font-mono py-3 rounded transition-colors">
                    RE-EXECUTAR DIAGNÓSTICO
                </button>
            </div>
        </div>
        
    </main>

    <footer class="text-center py-6 text-[10px] text-slate-600 font-mono relative z-10">
        <p>SECURESCAN LOCAL ENGINE | NO CLOUD UPLOAD | DATA PRIVACY GUARANTEED</p>
    </footer>

    <!-- LOGIC -->
    <script>
        // --- CONFIG & CONSTANTS ---
        const UI = {
            dropZone: document.getElementById('drop-zone'),
            staticUpload: document.getElementById('ui-upload-static'),
            scanningAnim: document.getElementById('ui-scanning-anim'),
            scanPercent: document.getElementById('scan-percent'),
            resultPanel: document.getElementById('result-panel'),
            verdictBanner: document.getElementById('verdict-banner'),
            verdictTitle: document.getElementById('verdict-title'),
            verdictDesc: document.getElementById('verdict-desc'),
            verdictIcon: document.getElementById('verdict-icon'),
            terminal: document.getElementById('terminal-output'),
            containerAnalysis: document.getElementById('container-analysis'),
            containerList: document.getElementById('container-list'),
            riskScore: document.getElementById('risk-score'),
            valEntropy: document.getElementById('val-entropy'),
            barEntropy: document.getElementById('bar-entropy'),
            valMagic: document.getElementById('val-magic'),
            valSize: document.getElementById('val-size'),
            valHash: document.getElementById('val-hash'),
        };

        const PATTERNS = {
            malicious: [
                { id: 'eval', regex: /eval\s*\(/i, score: 3, desc: 'JS Obfuscation (eval)' },
                { id: 'powershell', regex: /powershell(\.exe)?/i, score: 5, desc: 'PowerShell Command' },
                { id: 'cmd', regex: /cmd(\.exe)?\s*\/c/i, score: 4, desc: 'CMD Execution' },
                { id: 'ip_addr', regex: /\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b/, score: 2, desc: 'Embedded IPv4' },
                { id: 'base64_pe', regex: /TVqQAAMAAAAEAAAA/, score: 5, desc: 'Base64 Encoded Executable' },
                { id: 'wscript', regex: /WScript\.Shell/i, score: 4, desc: 'WScript Shell Object' },
                { id: 'autorun', regex: /\[autorun\]/i, score: 3, desc: 'Autorun Configuration' }
            ],
            pdf: [
                { id: 'pdf_js', regex: /\/JavaScript/i, score: 4, desc: 'PDF Embedded JavaScript' },
                { id: 'pdf_launch', regex: /\/Launch/i, score: 5, desc: 'PDF Launch Command' },
                { id: 'pdf_action', regex: /\/OpenAction/i, score: 3, desc: 'PDF Auto-Action' }
            ]
        };

        const MAGIC_BYTES = {
            '4d5a': 'EXE/DLL (Windows)',
            '504b0304': 'ZIP/Office/APK',
            '25504446': 'PDF Document',
            '7f454c46': 'ELF (Linux)',
            'd0cf11e0': 'Office Legacy (OLE)',
            '89504e47': 'PNG Image',
            'ffd8ffe0': 'JPEG Image'
        };

        const THREAT_HASHES = {
            // EICAR Standard Test File (MD5 & SHA256)
            '44d88612fea8a8f36de82e1278abb02f': 'EICAR Test File',
            '275a021bbfb6489e54d471899f7db9d1663fc695ec2fe2a2c4538aabf651fd0f': 'EICAR Test File',
            // Dummy hashes for demo purposes
            'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855': 'Empty File (Suspicious)',
        };

        // --- CORE FUNCTIONS ---

        function switchTab(tab) {
            const scanView = document.getElementById('view-scanner');
            const auditView = document.getElementById('view-audit');
            const btnScan = document.getElementById('tab-scanner');
            const btnAudit = document.getElementById('tab-audit');

            if (tab === 'scanner') {
                scanView.classList.remove('hidden');
                auditView.classList.add('hidden');
                btnScan.className = "px-6 py-2 rounded-md text-sm font-medium transition-all bg-blue-600 text-white shadow-lg shadow-blue-900/20";
                btnAudit.className = "px-6 py-2 rounded-md text-sm font-medium transition-all text-slate-400 hover:text-white hover:bg-slate-800";
            } else {
                scanView.classList.add('hidden');
                auditView.classList.remove('hidden');
                btnScan.className = "px-6 py-2 rounded-md text-sm font-medium transition-all text-slate-400 hover:text-white hover:bg-slate-800";
                btnAudit.className = "px-6 py-2 rounded-md text-sm font-medium transition-all bg-blue-600 text-white shadow-lg shadow-blue-900/20";
                runAudit();
            }
        }

        // TERMINAL LOGGING
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString('pt-BR', { hour12: false });
            
            let color = 'text-slate-400';
            let icon = '[*]';
            
            if (type === 'danger') { color = 'text-red-500'; icon = '[!]'; }
            else if (type === 'success') { color = 'text-green-400'; icon = '[+]'; }
            else if (type === 'warning') { color = 'text-yellow-400'; icon = '[?]'; }
            else if (type === 'system') { color = 'text-blue-400 font-bold'; icon = '[SYS]'; }

            div.innerHTML = `<span class="text-slate-600 mr-2">${time}</span><span class="${color}">${icon} ${msg}</span>`;
            
            // Remove the flashing cursor temporarily
            const cursor = UI.terminal.lastElementChild;
            if(cursor && cursor.innerHTML === '_') cursor.remove();

            UI.terminal.appendChild(div);
            
            // Add cursor back
            const newCursor = document.createElement('div');
            newCursor.className = "animate-pulse text-blue-500";
            newCursor.innerText = "_";
            UI.terminal.appendChild(newCursor);

            UI.terminal.scrollTop = UI.terminal.scrollHeight;
        }

        // FILE HANDLING
        async function handleFile(file) {
            if (!file) return;

            // Reset UI
            UI.resultPanel.classList.add('hidden');
            UI.containerAnalysis.classList.add('hidden');
            UI.staticUpload.classList.add('opacity-0');
            UI.scanningAnim.classList.remove('hidden');
            
            log('----------------------------------------');
            log(`Starting analysis: ${file.name}`, 'system');
            log(`Size: ${formatBytes(file.size)}`);

            let riskScore = 0;
            let triggers = [];

            try {
                // 1. RTLO Check (Spoofing)
                if (/\u202E/.test(file.name)) {
                    log('CRITICAL: RTLO character detected in filename!', 'danger');
                    riskScore += 10;
                    triggers.push('Spoofing de Extensão (RTLO)');
                }

                // 2. Read File
                const arrayBuffer = await readFileAsync(file);
                const uint8Array = new Uint8Array(arrayBuffer);
                const hexHeader = getHexHeader(uint8Array);
                
                // Progress Simulation
                updateProgress(20);

                // 3. Magic Bytes Analysis
                log(`Magic Bytes: ${hexHeader}`);
                let detectedType = "Desconhecido";
                let isExe = false;
                
                for (const [magic, desc] of Object.entries(MAGIC_BYTES)) {
                    if (hexHeader.startsWith(magic)) {
                        detectedType = desc;
                        if (desc.includes('EXE') || desc.includes('DLL')) isExe = true;
                        break;
                    }
                }
                UI.valMagic.innerText = `${hexHeader} (${detectedType})`;
                log(`File Type Identified: ${detectedType}`, 'success');

                // Check Extension Mismatch
                const ext = file.name.split('.').pop().toLowerCase();
                if (isExe && !['exe', 'dll', 'msi'].includes(ext)) {
                    log(`MISMATCH: Executable code in .${ext} file`, 'danger');
                    riskScore += 8;
                    triggers.push('Extensão Falsa (Exe disfarçado)');
                }

                updateProgress(40);

                // 4. Hash Calculation
                const hash = await crypto.subtle.digest('SHA-256', arrayBuffer);
                const hashArray = Array.from(new Uint8Array(hash));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                UI.valHash.innerText = hashHex;
                UI.valHash.dataset.full = hashHex; // store for copy
                log(`SHA-256 Calculated`, 'info');

                if (THREAT_HASHES[hashHex]) {
                    log(`HASH MATCH: Known Malware (${THREAT_HASHES[hashHex]})`, 'danger');
                    riskScore += 10;
                    triggers.push(`Malware Conhecido: ${THREAT_HASHES[hashHex]}`);
                }

                updateProgress(60);

                // 5. Entropy Analysis
                const entropy = calculateEntropy(uint8Array);
                UI.valEntropy.innerText = entropy.toFixed(2);
                UI.barEntropy.style.width = `${(entropy / 8) * 100}%`;
                
                if (entropy > 7.5) {
                    UI.barEntropy.className = "bg-red-500 h-full transition-all duration-1000";
                    log(`High Entropy (${entropy.toFixed(2)}): Potential Encryption/Packing`, 'warning');
                    if (['txt', 'log', 'js', 'bat'].includes(ext)) {
                        riskScore += 4; // High entropy in text files is very suspicious
                        triggers.push('Alta Entropia em Arquivo Texto');
                    }
                } else {
                    UI.barEntropy.className = "bg-blue-500 h-full transition-all duration-1000";
                }

                updateProgress(80);

                // 6. Content/Deep Scan
                const textContent = new TextDecoder('utf-8').decode(uint8Array.slice(0, 100000)); // Scan first 100KB text
                
                // Text Patterns
                const activePatterns = (detectedType.includes('PDF') || ext === 'pdf') ? [...PATTERNS.malicious, ...PATTERNS.pdf] : PATTERNS.malicious;

                activePatterns.forEach(p => {
                    if (p.regex.test(textContent)) {
                        log(`Pattern Detected: ${p.desc}`, 'warning');
                        riskScore += p.score;
                        triggers.push(p.desc);
                    }
                });

                // Archive Analysis (ZIP/DOCX/JAR)
                if (hexHeader.startsWith('504b0304')) {
                    log('Archive structure detected. Deep scanning...', 'system');
                    const zipTriggers = await analyzeZip(file);
                    if (zipTriggers.length > 0) {
                        riskScore += 5;
                        triggers = [...triggers, ...zipTriggers];
                    }
                }

                updateProgress(100);
                await sleep(500); // Visual pause

                // FINAL VERDICT
                UI.scanningAnim.classList.add('hidden');
                UI.staticUpload.classList.remove('opacity-0');
                UI.resultPanel.classList.remove('hidden');
                UI.valSize.innerText = formatBytes(file.size);

                renderVerdict(riskScore, triggers);

            } catch (err) {
                console.error(err);
                log('Error processing file', 'danger');
                UI.scanningAnim.classList.add('hidden');
                UI.staticUpload.classList.remove('opacity-0');
                alert('Erro ao processar arquivo. Verifique se o arquivo não está corrompido.');
            }
        }

        async function analyzeZip(file) {
            UI.containerAnalysis.classList.remove('hidden');
            UI.containerList.innerHTML = '';
            let detected = [];
            
            try {
                const zip = new JSZip();
                const content = await zip.loadAsync(file);
                const files = Object.keys(content.files);
                document.getElementById('files-count').innerText = files.length;
                
                let html = '';

                // Check for Office Macros
                if (files.includes('word/vbaProject.bin') || files.includes('xl/vbaProject.bin')) {
                    log('OFFICE MACRO DETECTED', 'danger');
                    detected.push('Macro VBA (Office)');
                    html += `<div class="flex justify-between px-2 py-1 bg-red-500/10 rounded"><span class="text-red-300 font-bold">vbaProject.bin</span><span class="text-red-500 font-bold">MACRO</span></div>`;
                }

                for (const filename of files) {
                    if (content.files[filename].dir) continue;
                    
                    const fExt = filename.split('.').pop().toLowerCase();
                    const isDangerous = ['exe', 'bat', 'vbs', 'ps1', 'js', 'jar', 'scr'].includes(fExt);
                    
                    let rowClass = isDangerous ? 'text-yellow-400' : 'text-slate-400';
                    let status = isDangerous ? 'SUSPEITO' : 'OK';
                    
                    if (isDangerous) {
                        html += `<div class="flex justify-between px-2 py-1 border-b border-slate-800/50"><span class="${rowClass} truncate w-3/4">${filename}</span><span class="text-[10px] font-bold text-yellow-500">${status}</span></div>`;
                        if (!detected.includes('Executável em Arquivo Comprimido')) detected.push('Executável em Arquivo Comprimido');
                    } else {
                        // Only show first 10 safe files to save DOM
                        if (files.indexOf(filename) < 10) {
                            html += `<div class="flex justify-between px-2 py-1 border-b border-slate-800/50"><span class="${rowClass} truncate w-3/4">${filename}</span><span class="text-[10px] text-slate-600">${status}</span></div>`;
                        }
                    }
                }
                
                UI.containerList.innerHTML = html;
            } catch (e) {
                log('Failed to parse archive structure', 'warning');
            }
            return detected;
        }

        function calculateEntropy(uint8Array) {
            const frequencies = new Array(256).fill(0);
            for (let i = 0; i < uint8Array.length; i++) {
                frequencies[uint8Array[i]]++;
            }
            
            let entropy = 0;
            const len = uint8Array.length;
            for (let i = 0; i < 256; i++) {
                if (frequencies[i] > 0) {
                    const p = frequencies[i] / len;
                    entropy -= p * Math.log2(p);
                }
            }
            return entropy;
        }

        function renderVerdict(score, triggers) {
            // Cap score at 10
            const finalScore = Math.min(score, 10);
            UI.riskScore.innerText = `${finalScore}/10`;

            let color = 'green';
            let title = 'Arquivo Limpo';
            let desc = 'Nenhuma ameaça significativa detectada.';
            let icon = '<i class="fa-solid fa-shield-check"></i>';

            if (finalScore >= 7) {
                color = 'red';
                title = 'AMEAÇA CRÍTICA';
                desc = triggers.join(', ') || 'Múltiplos indicadores de comprometimento.';
                icon = '<i class="fa-solid fa-radiation"></i>';
                log('VERDICT: MALICIOUS', 'danger');
            } else if (finalScore > 0) {
                color = 'yellow';
                title = 'Atenção Necessária';
                desc = triggers.join(', ');
                icon = '<i class="fa-solid fa-triangle-exclamation"></i>';
                log('VERDICT: SUSPICIOUS', 'warning');
            } else {
                log('VERDICT: CLEAN', 'success');
            }

            UI.verdictBanner.className = `glass-panel p-5 rounded-xl border-l-4 flex items-center justify-between transition-all border-${color}-500 bg-${color}-500/5`;
            UI.verdictIcon.className = `w-12 h-12 rounded-lg flex items-center justify-center text-2xl bg-${color}-500/20 text-${color}-500`;
            UI.verdictTitle.className = `font-bold text-xl text-${color}-400`;
            UI.verdictTitle.innerText = title;
            UI.verdictIcon.innerHTML = icon;
            UI.verdictDesc.innerText = desc;
            UI.riskScore.className = `text-2xl font-bold font-mono text-${color}-500`;
        }

        // --- UTILS ---
        function updateProgress(percent) {
            UI.scanPercent.innerText = `${percent}%`;
        }

        function readFileAsync(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function getHexHeader(uint8Array) {
            return Array.from(uint8Array.slice(0, 4)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function copyHash() {
            navigator.clipboard.writeText(UI.valHash.dataset.full);
            alert('Hash copiado!');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // --- AUDIT SYSTEM ---
        function runAudit() {
            const list = document.getElementById('audit-list');
            list.innerHTML = '';

            const checks = [
                { 
                    label: 'Conexão Segura (HTTPS)', 
                    check: window.location.protocol === 'https:', 
                    msgOk: 'Criptografado (TLS)', 
                    msgFail: 'Inseguro (HTTP)' 
                },
                { 
                    label: 'Cookies Habilitados', 
                    check: navigator.cookieEnabled, 
                    msgOk: 'Ativo', 
                    msgFail: 'Inativo' 
                },
                { 
                    label: 'User Agent', 
                    check: true, 
                    msgOk: navigator.userAgent.substring(0, 40) + '...', 
                    msgFail: '' 
                },
                {
                    label: 'Do Not Track',
                    check: (navigator.doNotTrack === "1"),
                    msgOk: 'Solicitação Enviada',
                    msgFail: 'Não configurado'
                },
                {
                    label: 'Plataforma',
                    check: true,
                    msgOk: navigator.platform,
                    msgFail: ''
                },
                {
                    label: 'Memória (aprox)',
                    check: navigator.deviceMemory,
                    msgOk: `${navigator.deviceMemory} GB`,
                    msgFail: 'Indisponível'
                }
            ];

            checks.forEach(c => {
                const color = c.check ? 'text-green-400' : 'text-red-400';
                const icon = c.check ? 'fa-check-circle' : 'fa-times-circle';
                
                // User Agent is neutral
                const displayColor = (c.label === 'User Agent' || c.label === 'Plataforma' || c.label.includes('Memória')) ? 'text-blue-400' : color;
                const displayIcon = (c.label === 'User Agent' || c.label === 'Plataforma' || c.label.includes('Memória')) ? 'fa-info-circle' : icon;

                const item = `
                <div class="flex items-center justify-between p-3 bg-slate-900/50 rounded-lg border border-slate-800">
                    <span class="text-sm font-medium text-slate-300">${c.label}</span>
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-mono ${displayColor}">${c.check ? c.msgOk : c.msgFail}</span>
                        <i class="fa-solid ${displayIcon} ${displayColor}"></i>
                    </div>
                </div>`;
                list.innerHTML += item;
            });
        }
    </script>
</body>
</html>
