<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SecureScan | Multi-Layer Analysis</title>
    
    <!-- Meta Tags para PWA e Mobile -->
    <meta name="theme-color" content="#0b1121">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SecureScan">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JSZip para ler arquivos dentro de ZIP/APK/DOCX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- √çcone e Manifesto PWA (Gerados Dinamicamente para funcionar em arquivo √∫nico) -->
    <script>
        // √çcone em Base64 (Escudo Azul)
        const iconBase64 = `data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyOCIgcnk9IjEyOCIgZmlsbD0iIzBmMTcyYSIvPjxwYXRoIGZpbGw9IiMzYjgyZjYiIGQ9Ik0yNTYgMzJDMTE0LjYgMzIgMCAxNDYuNiAwIDI4OHMxMTQuNiAyNTYgMjU2IDI1NiAyNTYtMTE0LjYgMjU2LTI1NlMzOTcuNCAzMiAyNTYgMzJ6bTAgNDcyYy0xMTkuMyAwLTIxNi05Ni43LTIxNi0yMTZTMTM2LjcgNzIgMjU2IDcyczIxNiA5Ni43IDIxNiAyMTYtOTYuNyAyMTYtMjE2IDIxNnoiLz48cGF0aCBmaWxsPSIjM2I4MmY2IiBkPSJNMzcyLjQgMjA0LjRMMjI4LjMgMzQ4LjVsLTg4LjctODguN2MtNi4zLTYuMy0xNi40LTYuMy0yMi42IDAtNi4zIDYuMy02LjMgMTYuNCAwIDIyLjZsMTAwIDEwMGM2LjMgNi4zIDE2LjQgNi4zIDIyLjYgMGwxNTUuMy0xNTUuM2M2LjMtNi4zIDYuMy0xNi40IDAtMjIuNi02LjItNi4zLTE2LjQtNi4zLTIyLjUtLjF6Ii8+PC9zdmc+`;

        // Injetar √çcone no Head
        const linkIcon = document.createElement('link');
        linkIcon.rel = 'icon';
        linkIcon.href = iconBase64;
        document.head.appendChild(linkIcon);

        const linkApple = document.createElement('link');
        linkApple.rel = 'apple-touch-icon';
        linkApple.href = iconBase64;
        document.head.appendChild(linkApple);

        // Criar Manifesto PWA Dinamicamente
        const manifest = {
            "name": "SecureScan Antiv√≠rus",
            "short_name": "SecureScan",
            "description": "Verificador de seguran√ßa web client-side.",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#0b1121",
            "theme_color": "#0b1121",
            "orientation": "portrait",
            "icons": [
                {
                    "src": iconBase64,
                    "sizes": "512x512",
                    "type": "image/svg+xml"
                }
            ]
        };

        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        
        const linkManifest = document.createElement('link');
        linkManifest.rel = 'manifest';
        linkManifest.href = manifestURL;
        document.head.appendChild(linkManifest);
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b1121;
            color: #e2e8f0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .glass-panel {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .drop-zone {
            background-image: repeating-linear-gradient(45deg, rgba(59, 130, 246, 0.05) 0, rgba(59, 130, 246, 0.05) 10px, transparent 10px, transparent 20px);
            border: 2px dashed #334155;
            transition: all 0.3s ease;
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
            transform: scale(1.005);
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: #3b82f6;
            box-shadow: 0 0 15px #3b82f6;
            animation: scanMove 2s linear infinite;
            z-index: 10;
        }

        @keyframes scanMove {
            0% { top: 0; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* Scrollbar customizada */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* Tabs Styles */
        .tab-btn {
            @apply px-4 py-2 text-sm font-medium rounded-lg transition-colors border border-transparent flex items-center justify-center;
        }
        .tab-active {
            @apply bg-blue-600 text-white border-blue-500 shadow-lg shadow-blue-900/50;
        }
        .tab-inactive {
            @apply text-slate-400 hover:text-white hover:bg-slate-800;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col pb-safe">

    <!-- Navbar -->
    <nav class="border-b border-slate-800 bg-slate-900/80 backdrop-blur sticky top-0 z-50 pt-safe">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-shield-halved text-blue-500 text-xl"></i>
                    <span class="font-bold text-lg tracking-tight text-white">SecureScan <span class="text-[10px] bg-blue-900/50 text-blue-300 px-2 py-0.5 rounded ml-1 border border-blue-500/30">APP</span></span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-[0_0_10px_#22c55e]"></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-6 flex flex-col items-center relative">
        
        <!-- Tab Switcher -->
        <div class="grid grid-cols-2 p-1 gap-1 bg-slate-900/60 rounded-xl mb-6 border border-slate-800 backdrop-blur-sm z-10 w-full max-w-md">
            <button onclick="switchTab('scanner')" id="btn-tab-scanner" class="tab-btn tab-active">
                <i class="fa-solid fa-file-magnifying-glass mr-2"></i>Escanear
            </button>
            <button onclick="switchTab('device')" id="btn-tab-device" class="tab-btn tab-inactive">
                <i class="fa-solid fa-mobile-screen-button mr-2"></i>Auditoria
            </button>
        </div>

        <!-- VIEW 1: FILE SCANNER -->
        <div id="view-scanner" class="w-full max-w-4xl flex flex-col items-center animate-fade-in">
            <div class="text-center mb-6 max-w-3xl z-10">
                <h1 class="font-bold mb-2 text-2xl md:text-4xl text-white">
                    An√°lise de Arquivos
                </h1>
                <p class="text-slate-400 text-xs md:text-sm max-w-xl mx-auto">
                    Suporte completo a <span class="font-mono text-[10px] bg-slate-800 px-1 rounded text-blue-300">ZIP APK DOCX PDF</span>
                </p>
            </div>

            <!-- Scanner Card -->
            <div class="w-full glass-panel rounded-xl overflow-hidden relative min-h-[400px] flex flex-col">
                <!-- Upload State -->
                <div id="upload-area" class="flex-grow flex flex-col items-center justify-center p-6 transition-all duration-300">
                    <div class="drop-zone w-full max-w-lg h-56 rounded-xl flex flex-col items-center justify-center cursor-pointer relative group" onclick="document.getElementById('file-input').click()">
                        <input type="file" id="file-input" class="hidden" onchange="handleFileSelect(this)">
                        
                        <div class="w-16 h-16 bg-slate-800/50 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300 border border-slate-700 shadow-xl shadow-blue-900/10">
                            <i class="fa-solid fa-magnifying-glass-chart text-2xl text-blue-500"></i>
                        </div>
                        <p class="text-lg font-bold text-white mb-1">Toque para verificar</p>
                        <p class="text-xs text-slate-400 text-center max-w-[250px]">
                            Busca execut√°veis ocultos e scripts maliciosos em documentos e pacotes.
                        </p>
                    </div>
                </div>

                <!-- Scanning State -->
                <div id="scanning-area" class="hidden absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center z-20">
                    <div class="scan-line"></div>
                    
                    <div class="relative w-16 h-16 mb-6">
                        <div class="absolute inset-0 border-4 border-slate-700 rounded-full"></div>
                        <div class="absolute inset-0 border-4 border-blue-500 rounded-full border-t-transparent animate-spin"></div>
                        <i class="fa-solid fa-fingerprint absolute inset-0 flex items-center justify-center text-slate-500 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-1" id="scan-status">Iniciando...</h3>
                    <p class="text-xs font-mono text-blue-400" id="scan-detail">Preparando...</p>
                </div>

                <!-- Result State -->
                <div id="result-area" class="hidden flex flex-col h-full animate-fade-in">
                    <!-- Header -->
                    <div class="bg-slate-800/50 p-4 border-b border-slate-700 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div class="flex items-center gap-3 w-full overflow-hidden">
                            <div id="file-icon-wrapper" class="w-10 h-10 rounded-lg bg-slate-700 flex items-center justify-center text-xl transition-colors shrink-0">
                                <i class="fa-solid fa-file"></i>
                            </div>
                            <div class="overflow-hidden min-w-0">
                                <h2 id="result-filename" class="font-bold text-white text-base truncate">arquivo.zip</h2>
                                <div class="flex items-center gap-2 text-[10px]">
                                    <span id="result-size" class="text-slate-400">0 MB</span>
                                    <span id="file-hash" class="font-mono bg-slate-900 px-2 py-0.5 rounded text-slate-500 truncate max-w-[80px]">HASH</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Painel de Resultados -->
                    <div class="flex-grow p-4 overflow-y-auto custom-scroll bg-slate-900/30">
                        
                        <!-- 1. Veredito -->
                        <div id="verdict-panel" class="mb-4 p-4 rounded-xl border flex flex-col sm:flex-row items-start gap-3 transition-all">
                            <!-- JS Populate -->
                        </div>

                        <!-- 2. Detalhes R√°pidos -->
                        <div class="grid grid-cols-1 gap-3 mb-4">
                            <div id="spoof-card" class="bg-slate-800/40 border border-slate-700 p-3 rounded-lg flex items-center gap-3">
                                <div id="spoof-icon" class="text-slate-500 text-lg"><i class="fa-solid fa-id-card"></i></div>
                                <div>
                                    <h4 class="text-[10px] font-bold text-slate-400 uppercase">Integridade</h4>
                                    <p id="spoof-text" class="text-xs text-slate-300">...</p>
                                </div>
                            </div>
                            
                             <div id="db-card" class="bg-slate-800/40 border border-slate-700 p-3 rounded-lg flex items-center gap-3">
                                <div id="db-icon" class="text-slate-500 text-lg"><i class="fa-solid fa-database"></i></div>
                                <div>
                                    <h4 class="text-[10px] font-bold text-slate-400 uppercase">Base de Amea√ßas</h4>
                                    <p id="db-text" class="text-xs text-slate-300">...</p>
                                </div>
                            </div>
                        </div>

                        <!-- 3. Deep Scan (ZIPs) -->
                        <div id="deep-scan-section" class="hidden">
                            <h4 class="text-slate-500 font-bold text-[10px] uppercase tracking-wider mb-2 border-b border-slate-800 pb-1">
                                Conte√∫do Interno (<span id="files-count">0</span>)
                            </h4>
                            <div class="bg-slate-900 border border-slate-800 rounded-lg overflow-hidden">
                                <div id="file-list-content" class="custom-scroll max-h-[200px] overflow-y-auto text-xs font-mono divide-y divide-slate-800/50"></div>
                            </div>
                        </div>
                        
                        <button onclick="resetScanner()" class="w-full mt-4 bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg text-sm font-bold transition-colors border border-slate-600">
                            Nova An√°lise
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: DEVICE AUDIT -->
        <div id="view-device" class="hidden w-full max-w-4xl flex flex-col items-center animate-fade-in">
            <div class="text-center mb-6 max-w-3xl z-10">
                <h1 class="font-bold mb-2 text-2xl md:text-4xl text-white">
                    Auditoria
                </h1>
                <p class="text-slate-400 text-xs md:text-sm max-w-xl mx-auto">
                    Verifique a seguran√ßa do seu ambiente de navega√ß√£o.
                </p>
            </div>

            <div class="w-full glass-panel rounded-xl overflow-hidden p-6">
                
                <div class="grid grid-cols-1 gap-4">
                    <!-- Browser Info -->
                    <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-8 h-8 rounded bg-blue-500/20 text-blue-400 flex items-center justify-center text-sm">
                                <i class="fa-brands fa-chrome"></i>
                            </div>
                            <h3 class="font-bold text-base text-white">Navegador</h3>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between border-b border-slate-700/50 pb-1">
                                <span class="text-slate-400 text-xs">Sistema</span>
                                <span id="audit-os" class="text-white text-xs font-bold">...</span>
                            </div>
                            <div class="flex justify-between items-center pt-1">
                                <span class="text-slate-400 text-xs">Cookies</span>
                                <span id="audit-cookies" class="px-2 py-0.5 rounded-[4px] text-[10px] font-bold bg-slate-700">...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Security Context -->
                    <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-8 h-8 rounded bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-sm">
                                <i class="fa-solid fa-lock"></i>
                            </div>
                            <h3 class="font-bold text-base text-white">Seguran√ßa</h3>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between border-b border-slate-700/50 pb-1">
                                <span class="text-slate-400 text-xs">Criptografia</span>
                                <span id="audit-protocol" class="text-white text-xs font-mono">...</span>
                            </div>
                             <div class="flex justify-between items-center pt-1">
                                <span class="text-slate-400 text-xs">Do Not Track</span>
                                <span id="audit-dnt" class="px-2 py-0.5 rounded-[4px] text-[10px] font-bold bg-slate-700">...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recommendation Panel -->
                <div class="mt-4 p-4 rounded-xl bg-slate-900/50 border border-slate-800 text-center">
                    <div id="audit-verdict" class="flex flex-col items-center gap-3">
                        <button onclick="runDeviceAudit()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold transition-colors shadow-lg shadow-blue-900/20">
                            Executar Diagn√≥stico
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <div class="mt-6 text-center text-[10px] text-slate-600 max-w-xs">
            <p><i class="fa-solid fa-check-shield mr-1"></i> SecureScan v3.0 (PWA Ready)</p>
            <p>O processamento √© local. Seus arquivos n√£o s√£o enviados para nenhum servidor.</p>
        </div>
    </main>

    <script>
        // --- TAB SWITCHING ---
        function switchTab(tabId) {
            const scannerView = document.getElementById('view-scanner');
            const deviceView = document.getElementById('view-device');
            const btnScanner = document.getElementById('btn-tab-scanner');
            const btnDevice = document.getElementById('btn-tab-device');

            if(tabId === 'scanner') {
                scannerView.classList.remove('hidden');
                deviceView.classList.add('hidden');
                btnScanner.className = 'tab-btn tab-active';
                btnDevice.className = 'tab-btn tab-inactive';
            } else {
                scannerView.classList.add('hidden');
                deviceView.classList.remove('hidden');
                btnScanner.className = 'tab-btn tab-inactive';
                btnDevice.className = 'tab-btn tab-active';
            }
        }

        // --- DEVICE AUDIT LOGIC ---
        function runDeviceAudit() {
            const ua = navigator.userAgent;
            const isSecure = window.isSecureContext;
            const cookies = navigator.cookieEnabled;
            const dnt = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
            const protocol = window.location.protocol;

            // Detect OS
            let os = "Desconhecido";
            if (ua.indexOf("Win") !== -1) os = "Windows";
            if (ua.indexOf("Mac") !== -1) os = "MacOS";
            if (ua.indexOf("Linux") !== -1) os = "Linux";
            if (ua.indexOf("Android") !== -1) os = "Android";
            if (ua.indexOf("like Mac") !== -1) os = "iOS";

            // Update UI
            document.getElementById('audit-os').innerText = os;
            document.getElementById('audit-protocol').innerText = protocol.toUpperCase().replace(':','');
            
            const cookieEl = document.getElementById('audit-cookies');
            cookieEl.innerText = cookies ? "ATIVO" : "INATIVO";
            cookieEl.className = cookies ? "px-2 py-0.5 rounded-[4px] text-[10px] font-bold bg-green-500/20 text-green-400" : "px-2 py-0.5 rounded-[4px] text-[10px] font-bold bg-red-500/20 text-red-400";

            const dntEl = document.getElementById('audit-dnt');
            const dntActive = dnt === "1" || dnt === "yes";
            dntEl.innerText = dntActive ? "ATIVO" : "INATIVO";
            dntEl.className = dntActive ? "px-2 py-0.5 rounded-[4px] text-[10px] font-bold bg-green-500/20 text-green-400" : "px-2 py-0.5 rounded-[4px] text-[10px] font-bold bg-yellow-500/20 text-yellow-400";

            // Verdict
            const verdictEl = document.getElementById('audit-verdict');
            let advice = [];
            
            if (!isSecure) advice.push("‚ö†Ô∏è SEM HTTPS: Sua conex√£o n√£o √© segura.");
            if (!dntActive) advice.push("‚ÑπÔ∏è RASTREAMENTO: 'N√£o Rastrear' est√° desligado.");
            if (os === "Android" || os === "iOS") advice.push("‚úÖ MOBILE: Sistema m√≥vel identificado.");
            else advice.push("üíª DESKTOP: Acesso via computador.");

            // Clear button
            verdictEl.innerHTML = '';
            
            const statusBox = document.createElement('div');
            statusBox.className = isSecure ? "w-full bg-green-500/10 border border-green-500/20 p-3 rounded-lg text-left" : "w-full bg-red-500/10 border border-red-500/20 p-3 rounded-lg text-left";
            
            let htmlContent = `
                <div class="flex items-center gap-2 mb-2 ${isSecure ? 'text-green-400' : 'text-red-400'}">
                    <i class="fa-solid ${isSecure ? 'fa-shield-check' : 'fa-triangle-exclamation'} text-xl"></i>
                    <span class="font-bold">${isSecure ? 'Ambiente Seguro' : 'Ambiente Vulner√°vel'}</span>
                </div>
                <div class="space-y-1">
            `;
            
            advice.forEach(msg => {
                htmlContent += `<p class="text-xs text-slate-300 border-b border-slate-700/50 pb-1 last:border-0">${msg}</p>`;
            });
            htmlContent += '</div>';
            
            statusBox.innerHTML = htmlContent;
            verdictEl.appendChild(statusBox);
        }

        // --- 1. BANCO DE DADOS DE AMEA√áAS (SIGNATURES) ---
        const THREAT_DB = {
            '275a021bbfb6489e54d471899f7db9d1663fc695ec2fe2a2c4538aabf651fd0f': 'EICAR Test File',
            '44d88612fea8a8f36de82e1278abb02f': 'EICAR Test (MD5)',
            '24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c': 'WannaCry (Dropper)',
            'cfc757367c29379899f8d52362a938db': 'WannaCry (Var)',
            '5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8': 'WannaCry (Comp)',
            'a294620543334a721a2e54764663e17b43b323c9655f633d9a1ee72054c52f0e': 'Stuxnet Worm'
        };

        // --- 2. CONFIGURA√á√ïES HEUR√çSTICAS ---
        const DANGEROUS_EXTENSIONS = ['exe', 'bat', 'cmd', 'sh', 'vbs', 'scr', 'js', 'jar', 'com', 'msi', 'apk', 'pif'];
        
        const MALICIOUS_PATTERNS = [
            { id: 'js_eval', regex: /eval\s*\(/i, desc: 'Obfusca√ß√£o JS' },
            { id: 'shell_ps', regex: /powershell(\.exe)?/i, desc: 'PowerShell' },
            { id: 'shell_cmd', regex: /cmd(\.exe)?\s*\/c/i, desc: 'CMD.exe' },
            { id: 'vba_macro', regex: /Attribute\s+VB_Name/i, desc: 'Macro VBA' },
            { id: 'base64_pe', regex: /TVqQAAMAAAAEAAAA/i, desc: 'Execut√°vel Base64' },
            { id: 'pdf_js', regex: /\/JavaScript|\/JS/i, desc: 'Script PDF' }
        ];

        // --- ESTADO DA UI ---
        const ui = {
            upload: document.getElementById('upload-area'),
            scanning: document.getElementById('scanning-area'),
            result: document.getElementById('result-area'),
            status: document.getElementById('scan-status'),
            detail: document.getElementById('scan-detail'),
            filename: document.getElementById('result-filename'),
            filesize: document.getElementById('result-size'),
            fileHash: document.getElementById('file-hash'),
            verdict: document.getElementById('verdict-panel'),
            fileIcon: document.getElementById('file-icon-wrapper'),
            spoofCard: { text: document.getElementById('spoof-text'), icon: document.getElementById('spoof-icon') },
            dbCard: { text: document.getElementById('db-text'), icon: document.getElementById('db-icon') },
            deepScan: {
                section: document.getElementById('deep-scan-section'),
                list: document.getElementById('file-list-content'),
                count: document.getElementById('files-count')
            }
        };

        // --- EVENTOS ---
        function handleFileSelect(input) {
            if(input.files.length) processFile(input.files[0]);
        }
        
        const dropZone = document.querySelector('.drop-zone');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
            dropZone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); });
        });
        ['dragenter', 'dragover'].forEach(() => dropZone.classList.add('dragover'));
        ['dragleave', 'drop'].forEach(() => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            if(e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]);
        });

        // --- L√ìGICA PRINCIPAL ---
        async function processFile(file) {
            resetUI();
            ui.upload.classList.add('hidden');
            ui.scanning.classList.remove('hidden');

            ui.filename.innerText = file.name;
            ui.filesize.innerText = formatBytes(file.size);

            let globalRisk = 'clean'; 
            let globalReason = 'Arquivo limpo.';

            // 1. Hash
            updateStatus("Assinatura...", "Calculando Hash");
            const hash = await calculateSHA256(file);
            ui.fileHash.innerText = hash.substring(0, 8);
            
            if (THREAT_DB[hash]) {
                globalRisk = 'danger';
                globalReason = `Malware: ${THREAT_DB[hash]}`;
                updateDbCard('danger', 'Hash encontrado na Blacklist!');
            } else {
                updateDbCard('clean', 'Hash limpo.');
            }

            await sleep(300);

            // 2. Spoofing
            updateStatus("Estrutura...", "Magic Bytes");
            const magicHeader = await readFileHeader(file);
            const ext = file.name.split('.').pop().toLowerCase();
            
            const isExe = magicHeader.startsWith('4d5a');
            const safeExts = ['pdf', 'jpg', 'png', 'txt', 'docx', 'xlsx'];
            
            if (isExe && safeExts.includes(ext)) {
                if (globalRisk !== 'danger') {
                    globalRisk = 'danger';
                    globalReason = `Spoofing: Arquivo .${ext} falso (√© um .EXE)`;
                }
                updateSpoofCard('danger', 'Extens√£o FALSA detectada!');
            } else {
                updateSpoofCard('clean', 'Estrutura consistente.');
            }

            await sleep(300);

            // 3. Deep Scan
            const isContainer = ['zip', 'docx', 'xlsx', 'pptx', 'jar', 'apk'].includes(ext);
            let deepResults = [];

            if (isContainer && globalRisk !== 'danger') {
                updateStatus("Extraindo...", "Analisando pacote");
                try {
                    deepResults = await scanZipContainer(file);
                    const threats = deepResults.filter(r => r.status === 'danger');
                    if (threats.length > 0) {
                        globalRisk = 'danger';
                        globalReason = `${threats.length} arquivos maliciosos internos.`;
                    }
                } catch (e) {
                    deepResults = [{ name: 'Erro', status: 'warning', reason: 'Falha ao abrir.' }];
                }
            } else if (!isContainer && isAnalysable(ext) && globalRisk !== 'danger') {
                updateStatus("Lendo...", "An√°lise de c√≥digo");
                const res = await scanSingleFile(file, file.name);
                if (res.status === 'danger') {
                    globalRisk = 'danger';
                    globalReason = res.reason;
                }
            }

            await sleep(300);
            renderFinalResult(globalRisk, globalReason, deepResults, isContainer);
        }

        // --- HELPERS ---
        async function calculateSHA256(file) {
            const buffer = await file.arrayBuffer();
            const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function readFileHeader(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = function(e) {
                    const arr = (new Uint8Array(e.target.result)).subarray(0, 4);
                    let header = "";
                    for(let i = 0; i < arr.length; i++) header += arr[i].toString(16).padStart(2, '0');
                    resolve(header);
                };
                reader.readAsArrayBuffer(file.slice(0, 4));
            });
        }

        async function scanZipContainer(file) {
            const zip = new JSZip();
            const contents = await zip.loadAsync(file);
            const results = [];
            const fileNames = Object.keys(contents.files);

            for (const filename of fileNames) {
                const zipObj = contents.files[filename];
                if (zipObj.dir) continue;

                const internalExt = filename.split('.').pop().toLowerCase();
                let analysis = { name: filename, status: 'clean', reason: '' };

                if (DANGEROUS_EXTENSIONS.includes(internalExt)) {
                    analysis = { name: filename, status: 'danger', reason: `Execut√°vel .${internalExt}` };
                } else if (isAnalysable(internalExt)) {
                    try {
                        const text = await zipObj.async("string");
                        const patterns = scanTextForPatterns(text, internalExt);
                        if (patterns.length > 0) analysis = { name: filename, status: 'danger', reason: patterns[0] };
                    } catch(e) {}
                }
                if (analysis.status !== 'clean') results.push(analysis);
                else results.push({name: filename, status: 'clean'});
            }
            return results;
        }

        async function scanSingleFile(file, filename) {
            const ext = filename.split('.').pop().toLowerCase();
            try {
                const text = await file.text();
                const patterns = scanTextForPatterns(text, ext);
                if (patterns.length > 0) return { name: filename, status: 'danger', reason: patterns[0] };
            } catch (e) {}
            return { name: filename, status: 'clean', reason: 'Limpo' };
        }

        function scanTextForPatterns(text, ext) {
            const found = [];
            const snippet = text.slice(0, 100000); 
            MALICIOUS_PATTERNS.forEach(pat => {
                if (pat.id.includes('pdf') && ext !== 'pdf') return;
                if (pat.regex.test(snippet)) found.push(pat.desc);
            });
            return found;
        }

        function isAnalysable(ext) {
            return ['js', 'html', 'htm', 'xml', 'txt', 'php', 'py', 'json', 'pdf', 'ps1'].includes(ext);
        }

        function renderFinalResult(risk, reason, deepFiles, isContainer) {
            ui.scanning.classList.add('hidden');
            ui.result.classList.remove('hidden');

            const verdictPanel = ui.verdict;
            let icon = risk === 'danger' ? 'fa-biohazard' : (risk === 'warning' ? 'fa-triangle-exclamation' : 'fa-shield-check');
            let color = risk === 'danger' ? 'red' : (risk === 'warning' ? 'yellow' : 'green');
            let title = risk === 'danger' ? 'Amea√ßa!' : (risk === 'warning' ? 'Aten√ß√£o' : 'Seguro');

            verdictPanel.className = `mb-4 p-4 rounded-xl border flex flex-col sm:flex-row items-center gap-4 bg-${color}-500/10 border-${color}-500/30`;
            verdictPanel.innerHTML = `
                <div class="w-10 h-10 rounded-lg bg-${color}-500/20 text-${color}-500 flex items-center justify-center text-2xl shrink-0">
                    <i class="fa-solid ${icon}"></i>
                </div>
                <div class="text-center sm:text-left">
                    <h3 class="text-${color}-400 font-bold text-lg">${title}</h3>
                    <p class="text-${color}-100/80 text-xs">${reason}</p>
                </div>
            `;
            ui.fileIcon.className = `w-10 h-10 rounded-lg bg-${color}-500/20 text-${color}-500 flex items-center justify-center text-xl transition-colors shrink-0`;

            if (isContainer) {
                ui.deepScan.section.classList.remove('hidden');
                ui.deepScan.count.innerText = deepFiles.length;
                deepFiles.sort((a, b) => (a.status === 'danger' ? -1 : 1));
                ui.deepScan.list.innerHTML = deepFiles.map(f => {
                    let c = f.status === 'danger' ? 'red' : 'slate';
                    return `<div class="flex justify-between px-2 py-1.5"><span class="text-slate-300 truncate w-3/4" title="${f.name}">${f.name}</span><span class="text-${c}-400 font-bold">${f.status === 'danger' ? 'V√çRUS' : 'OK'}</span></div>`;
                }).join('');
            } else {
                ui.deepScan.section.classList.add('hidden');
            }
        }

        function updateSpoofCard(status, text) {
            const color = status === 'danger' ? 'red' : 'green';
            const icon = status === 'danger' ? 'fa-xmark' : 'fa-check';
            ui.spoofCard.icon.className = `text-${color}-500 text-lg`;
            ui.spoofCard.icon.innerHTML = `<i class="fa-solid ${icon}"></i>`;
            ui.spoofCard.text.innerText = text;
            ui.spoofCard.text.className = `text-xs text-${color}-200/80`;
        }

        function updateDbCard(status, text) {
            const color = status === 'danger' ? 'red' : 'green';
            const icon = status === 'danger' ? 'fa-database text-red-500 animate-pulse' : 'fa-database';
            ui.dbCard.icon.className = `text-${color}-500 text-lg`;
            ui.dbCard.icon.innerHTML = `<i class="fa-solid ${icon}"></i>`;
            ui.dbCard.text.innerText = text;
            ui.dbCard.text.className = `text-xs text-${color}-200/80`;
        }

        function updateStatus(text, subtext) {
            ui.status.innerText = text;
            ui.detail.innerText = subtext;
        }

        function formatBytes(bytes) {
            if (!+bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(1))} ${sizes[i]}`;
        }

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
        function resetUI() { ui.result.classList.add('hidden'); }
        function resetScanner() { ui.result.classList.add('hidden'); ui.upload.classList.remove('hidden'); document.getElementById('file-input').value = ''; }
    </script>
</body>
</html>
